name: Build OnePlus 12r Docker Kernel (with KernelSU Next, SUSFS, BBG)
on:
  workflow_dispatch:
    inputs:
      ksu_commit_hash:
        description: 'KernelSU Next commit hash (leave empty for latest dev)'
        required: false
        type: string
        default: ''
      susfs_branch_or_commit:
        description: 'SUSFS branch or commit hash (empty for auto-detect based on kernel)'
        required: false
        type: string
        default: ''
      kernel_uname:
        description: 'Custom kernel uname (e.g., Bright-Star)'
        required: false
        type: string
        default: 'Bright-Star'
      build_modules:
        description: 'Build kernel modules (yes/no)'
        required: true
        type: choice
        options: ['no', 'yes']
        default: 'no'

jobs:
  build:
    name: Build Kernel by ${{ github.actor }}
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
    steps:
    - name: Set swap to 10G
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 10

    - name: Setup build kernel environment
      run: |
        echo "BUILD_TIME=$(TZ=Asia/Shanghai date "+%y%m%d")" >> $GITHUB_ENV
        sudo apt-get update
        sudo apt-get install git wget dwarves libelf-dev ccache automake flex lzop bison gperf build-essential zip curl zlib1g-dev g++-multilib libxml2-utils bzip2 libbz2-dev libbz2-1.0 libghc-bzlib-dev squashfs-tools pngcrush schedtool dpkg-dev liblz4-tool make optipng maven libssl-dev pwgen libswitch-perl policycoreutils minicom libxml-sax-base-perl libxml-simple-perl bc libc6-dev-i386 libx11-dev lib32z-dev libgl1-mesa-dev xsltproc unzip device-tree-compiler python3
        mkdir -p $GITHUB_WORKSPACE/kernel_workspace

    - name: Download kernel source
      run: |
        git clone https://github.com/OnePlusOSS/android_kernel_modules_and_devicetree_oneplus_sm8550 -b oneplus/sm8550_b_16.0.0_oneplus_12r kernel_workspace --depth=1
        cd $GITHUB_WORKSPACE/kernel_workspace
        cd kernel_platform
        git clone https://github.com/terminal-beginner/android_kernel_common_oneplus_12r.git -b oneplus/sm8550_b_16.0.0_oneplus_12r common --depth=1

    # ---------- Clean up ABI protected exports ----------
    - name: Clean up ABI protected exports
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/kernel_platform
        rm -f common/android/abi_gki_protected_exports_* || true
        rm -f msm-kernel/android/abi_gki_protected_exports_* || true

    # ---------- Get kernel version info (for SUSFS branch) ----------
    - name: Get kernel version info
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/kernel_platform/common
        for f in build.config.common build.config.constants; do
          if [ -f "$f" ]; then
            BRANCH_LINE=$(grep '^[[:space:]]*BRANCH=' "$f" || true)
            [ -n "$BRANCH_LINE" ] && break
          fi
        done
        [ -z "$BRANCH_LINE" ] && { echo "No BRANCH= found"; exit 1; }
        BRANCH_VALUE="${BRANCH_LINE#*=}"
        ANDROID_VERSION="${BRANCH_VALUE%-*}"
        VERSION=$(grep '^VERSION *=' Makefile | awk '{print $3}')
        PATCHLEVEL=$(grep '^PATCHLEVEL *=' Makefile | awk '{print $3}')
        SUBLEVEL=$(grep '^SUBLEVEL *=' Makefile | awk '{print $3}')
        FULL_VERSION="$VERSION.$PATCHLEVEL.$SUBLEVEL"
        echo "ANDROID_VER=$ANDROID_VERSION" >> $GITHUB_ENV
        echo "KERNEL_VER=$VERSION.$PATCHLEVEL" >> $GITHUB_ENV
        echo "KERNEL_FULL_VER=$ANDROID_VERSION-$FULL_VERSION" >> $GITHUB_ENV
        echo "SUSFS_KERNEL_BRANCH=gki-$ANDROID_VERSION-$VERSION.$PATCHLEVEL" >> $GITHUB_ENV

    # ---------- Add KernelSU Next ----------
    - name: Add KernelSU Next
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/kernel_platform
        curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/dev/kernel/setup.sh" | bash -
        git submodule update --init --recursive

        # If a specific commit hash was provided, check it out
        if [ -n "${{ github.event.inputs.ksu_commit_hash }}" ]; then
          cd KernelSU-Next
          git checkout "${{ github.event.inputs.ksu_commit_hash }}"
          cd kernel
        else
          cd KernelSU-Next/kernel
        fi

        # Recalculate KSU version based on current HEAD
        COMMITS_COUNT=$(git rev-list --count HEAD)
        if [ $COMMITS_COUNT -lt 2684 ]; then
          BASE_VERSION=10200
        else
          BASE_VERSION=30000
        fi
        KSU_VERSION=$((COMMITS_COUNT + BASE_VERSION))
        sed -i "s/DKSU_VERSION=11998/DKSU_VERSION=${KSU_VERSION}/" Makefile
        echo "KSU Version: $KSU_VERSION"
        cd ../..

    # ---------- Clone SUSFS repository ----------
    - name: Clone SUSFS
      run: |
        cd $GITHUB_WORKSPACE
        git clone https://gitlab.com/simonpunk/susfs4ksu.git
        cd susfs4ksu
        # Determine SUSFS branch: use input if provided, else auto-detect
        if [ -n "${{ github.event.inputs.susfs_branch_or_commit }}" ]; then
          SUSFS_BRANCH="${{ github.event.inputs.susfs_branch_or_commit }}"
        else
          SUSFS_BRANCH="${{ env.SUSFS_KERNEL_BRANCH }}"
        fi
        if git rev-parse --verify "origin/$SUSFS_BRANCH" >/dev/null 2>&1 || git rev-parse --verify "$SUSFS_BRANCH" >/dev/null 2>&1; then
          git checkout "$SUSFS_BRANCH"
          SUSFS_COMMIT_SHA=$(git rev-parse HEAD)
          echo "SUSFS_COMMIT_SHA=$SUSFS_COMMIT_SHA" >> $GITHUB_ENV
          echo "Checked out SUSFS branch: $SUSFS_BRANCH"
        else
          echo "::error::SUSFS branch '$SUSFS_BRANCH' not found."
          exit 1
        fi

    # ---------- Clone kernel_patches (for SUSFS fixes) ----------
    - name: Clone kernel_patches
      run: |
        cd $GITHUB_WORKSPACE
        git clone --depth=1 https://github.com/TheWildJames/kernel_patches.git

    # ---------- Clone my_patches (nullptr-t-oss) ----------
    - name: Clone my_patches
      run: |
        cd $GITHUB_WORKSPACE
        git clone --depth=1 https://github.com/terminal-beginner/kernel_patches.git my_patches

    # ---------- Apply SUSFS patches ----------
    - name: Apply SUSFS patches
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/kernel_platform
        # Copy SUSFS files
        cp $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/50_add_susfs_in_${{ env.SUSFS_KERNEL_BRANCH }}.patch ./common/
        cp $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/fs/* ./common/fs/
        cp $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/

        cd KernelSU-Next
        susfs_version=$(grep '#define SUSFS_VERSION' ../common/include/linux/susfs.h | awk -F'"' '{print $2}')
        echo "SUSFS Version: $susfs_version"

        # Apply KernelSU patch
        cp $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./
        patch -p1 --forward < 10_enable_susfs_for_ksu.patch || true

        # Version-specific fix patches (EXACTLY as in working workflow)
        case "$susfs_version" in
          "v1.5.8")
            cp $GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/fix_apk_sign.c.patch ./
            patch -p1 --forward --fuzz=3 < fix_apk_sign.c.patch
            cp $GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/fix_core_hook.c.patch ./
            patch -p1 --forward --fuzz=3 < fix_core_hook.c.patch
            cp $GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/fix_selinux.c.patch ./
            patch -p1 --forward --fuzz=3 < fix_selinux.c.patch
            cp $GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/fix_ksud.c.patch ./
            patch -p1 --forward --fuzz=3 < fix_ksud.c.patch
            ;;
          "v1.5.9"|"v1.5.10"|"v1.5.11"|"v1.5.12")
            for file in $(find ./kernel -maxdepth 2 -name "*.rej" -printf "%f\n" | cut -d'.' -f1); do
              echo "Patching file: $file.c with fix_$file.c.patch"
              patch -p1 --forward < "$GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/fix_$file.c.patch"
            done
            patch -p1 --forward < "$GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/fix_kernel_compat.c.patch"
            ;;
          "v2.0.0")
            for file in $(find ./kernel -maxdepth 2 -name "*.rej" -exec basename {} .rej \;); do
              echo "Patching file: $file with fix_$file.patch"
              patch -p1 --forward < "$GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/fix_$file.patch"
            done
            patch -p1 --forward < "$GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/overwrite_hook_mode.patch"
            patch -p1 --forward < "$GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/ksu_toolkit.patch"
            ;;
          *)
            echo "Unsupported SUSFS version: $susfs_version"
            exit 1
            ;;
        esac

        cd ../common
        patch -p1 < $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/50_add_susfs_in_${{ env.SUSFS_KERNEL_BRANCH }}.patch

        # Ptrace patch for kernels < 5.16
        KERNEL_VERSION="${{ env.KERNEL_VER }}"
        MIN_VERSION="5.16"
        if [ "$(printf '%s\n' "$KERNEL_VERSION" "$MIN_VERSION" | sort -V | head -n1)" = "$KERNEL_VERSION" ]; then
          echo "Applying ptrace patch"
          patch -p1 -F 3 < "$GITHUB_WORKSPACE/kernel_patches/gki_ptrace.patch"
        fi

    # ---------- Apply my patches ----------
    - name: Apply my patches
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/kernel_platform/common
        for patch_file in $GITHUB_WORKSPACE/my_patches/kernel_patches/op11/common/*.patch; do
          if [ -f "$patch_file" ]; then
            echo "Applying $patch_file"
            patch -p1 < "$patch_file"
          fi
        done

    # ---------- Add BBG (Baseband Guard) ----------
    - name: Add BBG
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/kernel_platform
        if ! wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash -s fix_blkdev_rename; then
          echo "::warning::BBG setup script failed, continuing anyway"
        fi

    - name: Download Clang-aosp
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        mkdir clang-aosp
        wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master-kernel-build-2022/clang-r450784e.tar.gz
        tar -C clang-aosp/ -zxvf clang-r450784e.tar.gz

    - name: Build kernel
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        KERNEL_DIR=./kernel_platform/common
        OUT_DIR=../../out
        DEFCONFIG="gki_defconfig vendor/kalama_GKI.config"
        export PATH=$GITHUB_WORKSPACE/kernel_workspace/clang-aosp/bin:$PATH
        export CLANG_TRIPLE=aarch64-linux-gnu-
        export ARCH=arm64
        export SUBARCH=arm64
        export HEADER_ARCH=arm64
        
        TOOL_ARGS=("ARCH=${ARCH}" "SUBARCH=${SUBARCH}" "HEADER_ARCH=${HEADER_ARCH}")
        CC=clang CXX=clang++ && TOOL_ARGS+=("CC=${CC}" "CXX=${CXX}")
        LD=ld.lld AR=llvm-ar NM=llvm-nm OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump READELF=llvm-readelf OBJSIZE=llvm-size STRIP=llvm-strip && TOOL_ARGS+=("LD=${LD}" "AR=${AR}" "NM=${NM}" "OBJCOPY=${OBJCOPY}" "OBJDUMP=${OBJDUMP}" "STRIP=${STRIP}")
        LLVM=1 LLVM_IAS=1 && TOOL_ARGS+=("LLVM=${LLVM}" "LLVM_IAS=${LLVM_IAS}")
        
        cd ${KERNEL_DIR}
        THREAD=$(nproc --all)
        
        make -j"$THREAD" "${TOOL_ARGS[@]}" O=${OUT_DIR} ${DEFCONFIG}
        scripts/config --file ${OUT_DIR}/.config -e LTO_CLANG -d LTO_NONE -e LTO_CLANG_THIN -d LTO_CLANG_FULL -e THINLTO
        wget https://raw.githubusercontent.com/terminal-beginner/Kernel-Builder_Action/refs/heads/Original/patches/a16_defconfig
        mv a16_defconfig ${OUT_DIR}/.config
        
        # Set custom LOCALVERSION based on input
        scripts/config --file ${OUT_DIR}/.config --set-str LOCALVERSION "-${ANDROID_VER}-${{ github.event.inputs.kernel_uname }}"
        scripts/config --file ${OUT_DIR}/.config -d LOCALVERSION_AUTO
        
        # Build kernel image
        make -j"$THREAD" O=${OUT_DIR} "${TOOL_ARGS[@]}" KCFLAGS="-Wno-error -pipe -fno-stack-protector ${KCFLAGS_EXTRA}" KCPPFLAGS="-DCONFIG_OPTIMIZE_INLINING" Image
        
        # Build kernel modules only if input is 'yes'
        if [ "${{ github.event.inputs.build_modules }}" = "yes" ]; then
          make -j"$THREAD" O=${OUT_DIR} "${TOOL_ARGS[@]}" modules
        fi
        
    # ---------- Collect and filter kernel modules (only if modules built) ----------
    - name: Collect and filter kernel modules
      if: github.event.inputs.build_modules == 'yes'
      run: |
        set -euo pipefail
        # Use the correct output directory
        cd $GITHUB_WORKSPACE/kernel_workspace/out
        MODULES_COLLECTION="modules_collection"
        mkdir -p "$MODULES_COLLECTION"
        # Find all .ko files and copy to collection
        find . -name "*.ko" -type f -exec cp {} "$MODULES_COLLECTION" \;
        if [ -n "$(ls -A "$MODULES_COLLECTION")" ]; then
          cd "$MODULES_COLLECTION"
          # Download default module list
          curl -L -o default_modules.txt https://raw.githubusercontent.com/nullptr-t-oss/kernel_patches/refs/heads/main/default_modules.txt
          # Remove modules listed in default_modules.txt
          while IFS= read -r module; do
            if [ -e "$module" ]; then
              rm -f "$module"
              echo "Removed module: $module"
            fi
          done < default_modules.txt
          # Set model name (you can change this if needed)
          MODEL="${OP_MODEL:-OnePlus12r}"
          MODULES_ZIP="kernel_modules_${MODEL}_${{ env.KERNEL_FULL_VER }}.zip"
          zip -r "$MODULES_ZIP" ./*
          # Move zip to artifacts directory
          mkdir -p $GITHUB_WORKSPACE/artifacts
          mv "$MODULES_ZIP" $GITHUB_WORKSPACE/artifacts/
          echo "Kernel modules zip created: $MODULES_ZIP"
        else
          echo "No kernel modules found."
        fi

    - name: Make Anykernel3
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        git clone https://github.com/Kernel-SU/AnyKernel3 --depth=1 AnyKernel3
        cp out/arch/arm64/boot/Image AnyKernel3/
        cd AnyKernel3
        sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
        sed -i 's!block=/dev/block/platform/omap/omap_hsmmc.0/by-name/boot;!block=/dev/block/bootdevice/by-name/boot;!g' anykernel.sh
        sed -i 's/is_slot_device=0;/is_slot_device=1;/g' anykernel.sh
        zip -r9 update.zip * -x .git README.md *placeholder
        mkdir -p $GITHUB_WORKSPACE/artifacts
        cp update.zip $GITHUB_WORKSPACE/artifacts/AnyKernel3_OnePlus12r_${{ env.KERNEL_FULL_VER }}_Next_${{ env.KSUVER }}_SuSFS_${{ env.SUSVER }}.zip

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-OnePlus12r-${{ env.BUILD_TIME }}
        path: artifacts/
