name: Build OnePlus 12r Docker Kernel (with KernelSU Next/SukiSU Ultra, SUSFS, BBG)
on:
  workflow_dispatch:
    inputs:
      # Kernel implementation choice
      ksu_type:
        description: 'Choose KernelSU implementation'
        required: true
        type: choice
        options:
          - KernelSU Next
          - SukiSU Ultra
        default: 'KernelSU Next'

      # KernelSU Next specific
      ksu_commit_hash:
        description: 'KernelSU Next commit hash (leave empty for latest dev)'
        required: false
        type: string
        default: ''

      # SukiSU Ultra specific
      manager_source:
        description: 'Manager source for SukiSU Ultra (if applicable)'
        required: false
        type: choice
        options:
          - MIUIX
          - MIUIX_SPOOF
          - MD3
          - MD3_SPOOF
        default: 'MIUIX'
      susfs_ci:
        description: 'SUSFS module download source'
        required: false
        type: choice
        options:
          - NoN
          - CI
          - Release
        default: 'NoN'
      kpm:
        description: 'Kernel module implementation'
        required: false
        type: choice
        options:
          - NoN
          - KPM
          - KPN
        default: 'NoN'
      susfs_meta:
        description: 'SUSFS commit hash override (empty for default)'
        required: false
        type: string
        default: ''
      zram:
        description: 'ZRAM settings (0/algorithm/size) - optional'
        required: false
        type: string
        default: ''

      # Common inputs
      kernel_uname:
        description: 'Custom kernel uname (e.g., Bright-Star)'
        required: false
        type: string
        default: 'Bright-Star'
      build_modules:
        description: 'Build kernel modules (yes/no)'
        required: true
        type: choice
        options: ['no', 'yes']
        default: 'no'
      optimize_level:
        description: 'Compiler optimization level (O2 or O3)'
        required: true
        type: choice
        options: ['O2', 'O3']
        default: 'O2'
      release_type:
        description: 'Select type of GitHub release'
        required: true
        type: choice
        options:
          - none
          - Pre-release
          - Release
        default: none
      manifest:
        description: 'Select manifest (used for release name)'
        required: true
        type: choice
        options:
          - OOS14
          - OOS15
          - OOS16
        default: OOS16
      model:
        description: 'Device model (for release name)'
        required: true
        type: string
        default: 'OP12r'
      generate_changelog:
        description: 'Generate changelog for release?'
        required: true
        type: boolean
        default: false

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-latest
    outputs:
      kernel_full_ver: ${{ steps.version.outputs.kernel_full_ver }}
      ksu_version: ${{ steps.ksu_version.outputs.ksu_version }}
      susfs_version: ${{ steps.susfs_version.outputs.susfs_version }}
      build_time: ${{ env.BUILD_TIME }}
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
    steps:
      - name: Set swap to 10G
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 10

      - name: Setup build kernel environment
        run: |
          echo "BUILD_TIME=$(TZ=Asia/Shanghai date "+%y%m%d")" >> $GITHUB_ENV
          sudo apt-get update
          sudo apt-get install -y git wget dwarves libelf-dev ccache automake flex lzop bison gperf build-essential zip curl zlib1g-dev g++-multilib libxml2-utils bzip2 libbz2-dev libbz2-1.0 libghc-bzlib-dev squashfs-tools pngcrush schedtool dpkg-dev liblz4-tool make optipng maven libssl-dev pwgen libswitch-perl policycoreutils minicom libxml-sax-base-perl libxml-simple-perl bc libc6-dev-i386 libx11-dev lib32z-dev libgl1-mesa-dev xsltproc unzip device-tree-compiler python3 jq
          mkdir -p $GITHUB_WORKSPACE/kernel_workspace

      - name: Download kernel source
        run: |
          git clone https://github.com/OnePlusOSS/android_kernel_modules_and_devicetree_oneplus_sm8550 -b oneplus/sm8550_b_16.0.0_oneplus_12r kernel_workspace --depth=1
          cd $GITHUB_WORKSPACE/kernel_workspace
          cd kernel_platform
          git clone https://github.com/terminal-beginner/android_kernel_common_oneplus_12r.git -b oneplus/sm8550_b_16.0.0_oneplus_12r common --depth=1

      # ---------- Clean up ABI protected exports ----------
      - name: Clean up ABI protected exports
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace/kernel_platform
          rm -f common/android/abi_gki_protected_exports_* || true
          rm -f msm-kernel/android/abi_gki_protected_exports_* || true

      # ---------- Get kernel version info ----------
      - name: Get kernel version info
        id: version
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace/kernel_platform/common
          for f in build.config.common build.config.constants; do
            if [ -f "$f" ]; then
              BRANCH_LINE=$(grep '^[[:space:]]*BRANCH=' "$f" || true)
              [ -n "$BRANCH_LINE" ] && break
            fi
          done
          [ -z "$BRANCH_LINE" ] && { echo "No BRANCH= found"; exit 1; }
          BRANCH_VALUE="${BRANCH_LINE#*=}"
          ANDROID_VERSION="${BRANCH_VALUE%-*}"
          VERSION=$(grep '^VERSION *=' Makefile | awk '{print $3}')
          PATCHLEVEL=$(grep '^PATCHLEVEL *=' Makefile | awk '{print $3}')
          SUBLEVEL=$(grep '^SUBLEVEL *=' Makefile | awk '{print $3}')
          FULL_VERSION="$VERSION.$PATCHLEVEL.$SUBLEVEL"
          echo "ANDROID_VER=$ANDROID_VERSION" >> $GITHUB_ENV
          echo "KERNEL_VER=$VERSION.$PATCHLEVEL" >> $GITHUB_ENV
          echo "KERNEL_FULL_VER=$ANDROID_VERSION-$FULL_VERSION" >> $GITHUB_ENV
          echo "SUSFS_KERNEL_BRANCH=gki-$ANDROID_VERSION-$VERSION.$PATCHLEVEL" >> $GITHUB_ENV
          echo "kernel_full_ver=$ANDROID_VERSION-$FULL_VERSION" >> $GITHUB_OUTPUT

      # ---------- Clone common patch repos (used by both implementations) ----------
      - name: Clone common patch repositories
        run: |
          cd $GITHUB_WORKSPACE
          git clone https://gitlab.com/simonpunk/susfs4ksu.git
          git clone --depth=1 https://github.com/TheWildJames/kernel_patches.git
          git clone --depth=1 https://github.com/terminal-beginner/kernel_patches.git my_patches

      # ---------- KERNEL IMPLEMENTATION: KernelSU Next ----------
      - name: Setup KernelSU Next
        if: ${{ github.event.inputs.ksu_type == 'KernelSU Next' }}
        id: ksu_next
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace/kernel_platform
          curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/dev/kernel/setup.sh" | bash -
          git submodule update --init --recursive
          if [ -n "${{ github.event.inputs.ksu_commit_hash }}" ]; then
            cd KernelSU-Next
            git checkout "${{ github.event.inputs.ksu_commit_hash }}"
            cd kernel
          else
            cd KernelSU-Next/kernel
          fi
          COMMITS_COUNT=$(git rev-list --count HEAD)
          if [ $COMMITS_COUNT -lt 2684 ]; then
            BASE_VERSION=10200
          else
            BASE_VERSION=30000
          fi
          KSU_VERSION=$((COMMITS_COUNT + BASE_VERSION))
          sed -i "s/DKSU_VERSION=11998/DKSU_VERSION=${KSU_VERSION}/" Makefile
          echo "KSU Version: $KSU_VERSION"
          echo "ksu_version=$KSU_VERSION" >> $GITHUB_OUTPUT
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
          cd ../..

      # ---------- KERNEL IMPLEMENTATION: SukiSU Ultra ----------
      - name: Setup SukiSU Ultra
        if: ${{ github.event.inputs.ksu_type == 'SukiSU Ultra' }}
        id: sukisu
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace/kernel_platform
          # Determine manager branch
          MANAGER_SOURCE="${{ github.event.inputs.manager_source }}"
          case "$MANAGER_SOURCE" in
            MD3)
              MANAGER_BRANCH="old"
              MANAGER_ARTIFACT="Manager"
              ;;
            MD3_SPOOF)
              MANAGER_BRANCH="old"
              MANAGER_ARTIFACT="Spoofed-Manager"
              ;;
            MIUIX_SPOOF)
              MANAGER_BRANCH="main"
              MANAGER_ARTIFACT="Spoofed-Manager"
              ;;
            MIUIX|*)
              MANAGER_BRANCH="main"
              MANAGER_ARTIFACT="Manager"
              ;;
          esac
          echo "MANAGER_BRANCH=$MANAGER_BRANCH" >> $GITHUB_ENV
          echo "MANAGER_ARTIFACT=$MANAGER_ARTIFACT" >> $GITHUB_ENV

          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/${MANAGER_BRANCH}/kernel/setup.sh" | bash -s "main"
          cd KernelSU

          # Optional commit override via KSU_META (we'll reuse the input? Not directly; we can add an input for sukisu hash later)
          # For now, no override

          # Get API version from Kbuild
          KSU_API_VERSION=$(curl -fsSL "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/$MANAGER_BRANCH/kernel/Kbuild" | grep -m1 "KSU_VERSION_API :=" | awk -F'= ' '{print $2}' | tr -d '[:space:]')
          if [[ -z "$KSU_API_VERSION" || "$(printf '%s\n' "$KSU_API_VERSION" "3.1.7" | sort -V | head -n1)" != "3.1.7" ]]; then
            KSU_API_VERSION="3.1.7"
          fi
          GIT_HASH=$(git rev-parse --short HEAD)
          VERSION_FULL="v$KSU_API_VERSION-$GIT_HASH@$MANAGER_BRANCH"

          # Inject version into Kbuild
          sed -i '/define get_ksu_version_full/,/endef/d' kernel/Kbuild
          sed -i '/KSU_VERSION_API :=/d' kernel/Kbuild
          sed -i '/KSU_VERSION_FULL :=/d' kernel/Kbuild
          cat <<EOF >> kernel/Kbuild
          define get_ksu_version_full
          $VERSION_FULL
          endef

          KSU_VERSION_API := $KSU_API_VERSION
          KSU_VERSION_FULL := $VERSION_FULL
          EOF

          KSU_VERSION=$(expr $(git rev-list --count "$MANAGER_BRANCH" 2>/dev/null || echo 13000) + 37185)
          echo "KSU Version: $KSU_VERSION"
          echo "ksu_version=$KSU_VERSION" >> $GITHUB_OUTPUT
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
          cd ../..

      # ---------- SUSFS patches (common) ----------
      - name: Apply SUSFS patches
        id: susfs
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace/kernel_platform
          # Determine SUSFS branch
          if [ -n "${{ github.event.inputs.susfs_meta }}" ]; then
            SUSFS_BRANCH="${{ github.event.inputs.susfs_meta }}"
          else
            SUSFS_BRANCH="${{ env.SUSFS_KERNEL_BRANCH }}"
          fi
          # Checkout SUSFS
          cd $GITHUB_WORKSPACE/susfs4ksu
          if git rev-parse --verify "origin/$SUSFS_BRANCH" >/dev/null 2>&1 || git rev-parse --verify "$SUSFS_BRANCH" >/dev/null 2>&1; then
            git checkout "$SUSFS_BRANCH"
            SUSFS_COMMIT_SHA=$(git rev-parse HEAD)
            echo "SUSFS_COMMIT_SHA=$SUSFS_COMMIT_SHA" >> $GITHUB_ENV
          else
            echo "::error::SUSFS branch '$SUSFS_BRANCH' not found."
            exit 1
          fi
          cd $GITHUB_WORKSPACE/kernel_workspace/kernel_platform

          # Copy SUSFS files
          cp $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/50_add_susfs_in_${{ env.SUSFS_KERNEL_BRANCH }}.patch ./common/
          cp $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/fs/* ./common/fs/
          cp $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/

          cd KernelSU-Next 2>/dev/null || cd KernelSU 2>/dev/null || true
          susfs_version=$(grep '#define SUSFS_VERSION' ../common/include/linux/susfs.h | awk -F'"' '{print $2}')
          echo "SUSFS Version: $susfs_version"
          echo "susfs_version=$susfs_version" >> $GITHUB_OUTPUT
          echo "SUSVER=$susfs_version" >> $GITHUB_ENV

          # Apply the enable patch (present in both KernelSU and KernelSU-Next)
          cp $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./
          patch -p1 --forward < 10_enable_susfs_for_ksu.patch || true

          # Version-specific fixes (from TheWildJames kernel_patches)
          case "$susfs_version" in
            "v1.5.8")
              cp $GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/fix_apk_sign.c.patch ./
              patch -p1 --forward --fuzz=3 < fix_apk_sign.c.patch
              cp $GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/fix_core_hook.c.patch ./
              patch -p1 --forward --fuzz=3 < fix_core_hook.c.patch
              cp $GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/fix_selinux.c.patch ./
              patch -p1 --forward --fuzz=3 < fix_selinux.c.patch
              cp $GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/fix_ksud.c.patch ./
              patch -p1 --forward --fuzz=3 < fix_ksud.c.patch
              ;;
            "v1.5.9"|"v1.5.10"|"v1.5.11"|"v1.5.12")
              for file in $(find ./kernel -maxdepth 2 -name "*.rej" -printf "%f\n" | cut -d'.' -f1); do
                echo "Patching file: $file.c with fix_$file.c.patch"
                patch -p1 --forward < "$GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/fix_$file.c.patch"
              done
              patch -p1 --forward < "$GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/fix_kernel_compat.c.patch"
              ;;
            "v2.0.0")
              for file in $(find ./kernel -maxdepth 2 -name "*.rej" -exec basename {} .rej \;); do
                echo "Patching file: $file with fix_$file.patch"
                patch -p1 --forward < "$GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/fix_$file.patch"
              done
              patch -p1 --forward < "$GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/overwrite_hook_mode.patch"
              patch -p1 --forward < "$GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/ksu_toolkit.patch"
              ;;
            *)
              echo "Unsupported SUSFS version: $susfs_version"
              exit 1
              ;;
          esac

          cd ../common
          patch -p1 < $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/50_add_susfs_in_${{ env.SUSFS_KERNEL_BRANCH }}.patch

          # Ptrace patch for kernels < 5.16
          KERNEL_VERSION="${{ env.KERNEL_VER }}"
          MIN_VERSION="5.16"
          if [ "$(printf '%s\n' "$KERNEL_VERSION" "$MIN_VERSION" | sort -V | head -n1)" = "$KERNEL_VERSION" ]; then
            echo "Applying ptrace patch"
            patch -p1 -F 3 < "$GITHUB_WORKSPACE/kernel_patches/gki_ptrace.patch"
          fi

      # ---------- Apply my patches (nullptr-t-oss) ----------
      - name: Apply my patches
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace/kernel_platform/common
          for patch_file in $GITHUB_WORKSPACE/my_patches/kernel_patches/op11/common/*.patch; do
            if [ -f "$patch_file" ]; then
              echo "Applying $patch_file"
              patch -p1 < "$patch_file"
            fi
          done

      # ---------- Add memkernel module ----------
      - name: Add memkernel module
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace/kernel_platform/common
          curl -LSs "https://raw.githubusercontent.com/Poko-Apps/MemKernel/main/kernel/setup.sh" | bash -s M br0k3n

      # ---------- Add BBG ----------
      - name: Add BBG
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace/kernel_platform
          if ! wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash -s fix_blkdev_rename; then
            echo "::warning::BBG setup script failed, continuing anyway"
          fi

      - name: Download Clang-aosp
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace
          mkdir clang-aosp
          wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master-kernel-build-2022/clang-r450784e.tar.gz
          tar -C clang-aosp/ -zxvf clang-r450784e.tar.gz

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2.19
        with:
          key: ${{ env.KERNEL_FULL_VER }}
          max-size: 5G
          append-timestamp: false
          create-symlink: true
          job-summary: 'CCache stats'
          save: true

      - name: Build kernel
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace
          KERNEL_DIR=./kernel_platform/common
          OUT_DIR=../../out
          DEFCONFIG="gki_defconfig vendor/kalama_GKI.config"
          export PATH=$PWD/clang-aosp/bin:$PATH
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export ARCH=arm64
          export SUBARCH=arm64
          export HEADER_ARCH=arm64
          export PATH="/usr/lib/ccache:$PATH"

          TOOL_ARGS=("ARCH=${ARCH}" "SUBARCH=${SUBARCH}" "HEADER_ARCH=${HEADER_ARCH}")
          CC=clang CXX=clang++ && TOOL_ARGS+=("CC=${CC}" "CXX=${CXX}")
          LD=ld.lld AR=llvm-ar NM=llvm-nm OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump READELF=llvm-readelf OBJSIZE=llvm-size STRIP=llvm-strip && TOOL_ARGS+=("LD=${LD}" "AR=${AR}" "NM=${NM}" "OBJCOPY=${OBJCOPY}" "OBJDUMP=${OBJDUMP}" "STRIP=${STRIP}")
          LLVM=1 LLVM_IAS=1 && TOOL_ARGS+=("LLVM=${LLVM}" "LLVM_IAS=${LLVM_IAS}")

          cd ${KERNEL_DIR}
          THREAD=$(nproc --all)

          make -j"$THREAD" "${TOOL_ARGS[@]}" O=${OUT_DIR} ${DEFCONFIG}
          scripts/config --file ${OUT_DIR}/.config -e LTO_CLANG -d LTO_NONE -e LTO_CLANG_THIN -d LTO_CLANG_FULL -e THINLTO
          wget https://raw.githubusercontent.com/terminal-beginner/Nethunter-Kernel-For-Oneplus12R/refs/heads/main/patches/a16_defconfig
          mv a16_defconfig ${OUT_DIR}/.config

          # Set optimization level
          if [ "${{ github.event.inputs.optimize_level }}" = "O3" ]; then
            scripts/config --file ${OUT_DIR}/.config -d CC_OPTIMIZE_FOR_PERFORMANCE
            scripts/config --file ${OUT_DIR}/.config -e CC_OPTIMIZE_FOR_PERFORMANCE_O3
            KCFLAGS_EXTRA="-O3"
          else
            scripts/config --file ${OUT_DIR}/.config -e CC_OPTIMIZE_FOR_PERFORMANCE
            scripts/config --file ${OUT_DIR}/.config -d CC_OPTIMIZE_FOR_PERFORMANCE_O3
            KCFLAGS_EXTRA="-O2"
          fi

          # Set custom LOCALVERSION
          scripts/config --file ${OUT_DIR}/.config --set-str LOCALVERSION "-${ANDROID_VER}-${{ github.event.inputs.kernel_uname }}"
          scripts/config --file ${OUT_DIR}/.config -d LOCALVERSION_AUTO

          # Build kernel image
          make -j"$THREAD" O=${OUT_DIR} "${TOOL_ARGS[@]}" KCFLAGS="-Wno-error -pipe -fno-stack-protector ${KCFLAGS_EXTRA}" KCPPFLAGS="-DCONFIG_OPTIMIZE_INLINING" Image

          # Build modules if requested
          if [ "${{ github.event.inputs.build_modules }}" = "yes" ]; then
            make -j"$THREAD" O=${OUT_DIR} "${TOOL_ARGS[@]}" modules
          fi

      # ---------- (Optional) KPM patch after build ----------
      - name: Apply KPM patch (if KPM selected)
        if: ${{ github.event.inputs.kpm == 'KPM' }}
        run: |
          PATCH_DIR="$GITHUB_WORKSPACE/kernel_workspace/SukiSU_patch/kpm"
          OUT_DIR="$GITHUB_WORKSPACE/kernel_workspace/kernel_platform/out"
          mkdir -p "$OUT_DIR"
          cp "${PATCH_DIR}/patch_linux" "$OUT_DIR/"
          cd "$OUT_DIR"
          chmod +x patch_linux
          ./patch_linux
          rm -f Image
          mv oImage Image

      # ---------- Collect and filter kernel modules ----------
      - name: Collect and filter kernel modules
        if: github.event.inputs.build_modules == 'yes'
        run: |
          set -euo pipefail
          cd $GITHUB_WORKSPACE/kernel_workspace/out
          MODULES_COLLECTION="modules_collection"
          mkdir -p "$MODULES_COLLECTION"
          find . -name "*.ko" -type f -exec cp {} "$MODULES_COLLECTION" \;
          if [ -n "$(ls -A "$MODULES_COLLECTION")" ]; then
            cd "$MODULES_COLLECTION"
            curl -L -o default_modules.txt https://raw.githubusercontent.com/nullptr-t-oss/kernel_patches/refs/heads/main/default_modules.txt
            while IFS= read -r module; do
              if [ -e "$module" ]; then
                rm -f "$module"
                echo "Removed module: $module"
              fi
            done < default_modules.txt
            MODEL="${OP_MODEL:-OnePlus12r}"
            MODULES_ZIP="kernel_modules_${MODEL}_${{ env.KERNEL_FULL_VER }}.zip"
            zip -r "$MODULES_ZIP" ./*
            mkdir -p $GITHUB_WORKSPACE/artifacts
            mv "$MODULES_ZIP" $GITHUB_WORKSPACE/artifacts/
            echo "Kernel modules zip created: $MODULES_ZIP"
          else
            echo "No kernel modules found."
          fi

      # ---------- Save kernel metadata and config ----------
      - name: Save kernel metadata and config
        run: |
          mkdir -p $GITHUB_WORKSPACE/artifacts
          cp $GITHUB_WORKSPACE/kernel_workspace/out/.config $GITHUB_WORKSPACE/artifacts/kernel_config_${{ env.KERNEL_FULL_VER }}.txt
          echo "${{ env.KERNEL_FULL_VER }}" > $GITHUB_WORKSPACE/artifacts/OnePlus12r.txt

      - name: Make Anykernel3
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace
          git clone https://github.com/Kernel-SU/AnyKernel3 --depth=1 AnyKernel3
          cp out/arch/arm64/boot/Image AnyKernel3/
          cd AnyKernel3
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
          sed -i 's!block=/dev/block/platform/omap/omap_hsmmc.0/by-name/boot;!block=/dev/block/bootdevice/by-name/boot;!g' anykernel.sh
          sed -i 's/is_slot_device=0;/is_slot_device=1;/g' anykernel.sh
          KSU_VER="${{ steps.ksu_next.outputs.ksu_version || steps.sukisu.outputs.ksu_version }}"
          SUS_VER="${{ steps.susfs.outputs.susfs_version }}"
          zip -r9 update.zip * -x .git README.md *placeholder
          mkdir -p $GITHUB_WORKSPACE/artifacts
          cp update.zip $GITHUB_WORKSPACE/artifacts/AnyKernel3_OnePlus12r_${{ env.KERNEL_FULL_VER }}_Next_${KSU_VER}_SuSFS_${SUS_VER}.zip

      # ---------- Download SukiSU manager APK (if applicable) ----------
      - name: Download SukiSU manager APK
        if: ${{ github.event.inputs.ksu_type == 'SukiSU Ultra' }}
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MANAGER_BRANCH="${{ env.MANAGER_BRANCH }}"
          MANAGER_ARTIFACT="${{ env.MANAGER_ARTIFACT }}"
          run_id=$(gh api "repos/SukiSU-Ultra/SukiSU-Ultra/actions/workflows/build-manager.yml/runs?branch=$MANAGER_BRANCH&status=success&per_page=1" --jq '.workflow_runs[0].id' || echo "")
          if [[ -z "$run_id" ]]; then
            echo "No successful workflow run found on branch $MANAGER_BRANCH. Skipping download."
            exit 0
          fi
          artifact_url=$(gh api "repos/SukiSU-Ultra/SukiSU-Ultra/actions/runs/$run_id/artifacts" | jq -r ".artifacts[] | select(.name == \"$MANAGER_ARTIFACT\") | .archive_download_url" | head -n1)
          if [[ -z "$artifact_url" ]]; then
            echo "No artifact '$MANAGER_ARTIFACT' found in run $run_id. Skipping download."
            exit 0
          fi
          curl -fL -H "Authorization: token $GITHUB_TOKEN" -o "${MANAGER_ARTIFACT}.zip" "$artifact_url"
          unzip -j "${MANAGER_ARTIFACT}.zip" "*.apk" -d $GITHUB_WORKSPACE/artifacts/

      # ---------- Download SUSFS module (if requested) ----------
      - name: Download SUSFS module from CI
        if: ${{ github.event.inputs.susfs_ci == 'CI' && github.event.inputs.susfs_meta != '-1' }}
        continue-on-error: true
        run: |
          LATEST_RUN_ID=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/sidex15/susfs4ksu-module/actions/runs?status=success" | \
            jq -r '.workflow_runs[] | select(.head_branch == "v1.5.2+") | .id' | head -n 1)
          if [ -z "$LATEST_RUN_ID" ]; then
            echo "No successful run found for branch v1.5.2+"
          else
            ARTIFACT_URL=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/sidex15/susfs4ksu-module/actions/runs/$LATEST_RUN_ID/artifacts" | jq -r '.artifacts[0].archive_download_url')
            if [ -n "$ARTIFACT_URL" ]; then
              curl -L -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -o ksu_module_susfs_1.5.2+_CI.zip "$ARTIFACT_URL"
              cp ksu_module_susfs_1.5.2+_CI.zip $GITHUB_WORKSPACE/artifacts/
            else
              echo "Failed to fetch artifact URL"
            fi
          fi

      - name: Download SUSFS module from Release
        if: ${{ github.event.inputs.susfs_ci == 'Release' && github.event.inputs.susfs_meta != '-1' }}
        continue-on-error: true
        run: |
          wget -O ksu_module_susfs_1.5.2+_Release.zip https://github.com/sidex15/ksu_module_susfs/releases/latest/download/ksu_module_susfs_1.5.2+.zip
          cp ksu_module_susfs_1.5.2+_Release.zip $GITHUB_WORKSPACE/artifacts/

      # ---------- Upload kernel artifacts ----------
      - name: Upload kernel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ env.KERNEL_FULL_VER }}
          path: artifacts/AnyKernel3_*.zip
          retention-days: 7
          if-no-files-found: error

      - name: Upload modules artifacts
        if: github.event.inputs.build_modules == 'yes'
        uses: actions/upload-artifact@v4
        with:
          name: modules-${{ env.KERNEL_FULL_VER }}
          path: artifacts/kernel_modules_*.zip
          retention-days: 7
          if-no-files-found: error

      - name: Upload config artifact
        uses: actions/upload-artifact@v4
        with:
          name: config-${{ env.KERNEL_FULL_VER }}
          path: artifacts/kernel_config_*.txt
          retention-days: 7
          if-no-files-found: error

  # ---------- Release job (if release_type != none) ----------
  release:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.release_type != 'none' }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code (for tag creation)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts

      - name: Generate release name and tag
        run: |
          DEVICE="OnePlus ${{ github.event.inputs.model }}"
          RELEASE_NAME="$DEVICE Kernel ${{ needs.build.outputs.kernel_full_ver }}"
          echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV
          BASE_TAG="v2.0.0-r0"
          LATEST_TAG=$(gh api repos/${{ github.repository }}/tags --jq '.[0].name' 2>/dev/null || echo "")
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="$BASE_TAG"
          else
            LATEST_TAG=$(printf "%s\n%s\n" "$LATEST_TAG" "$BASE_TAG" | sort -rV | head -n1)
          fi
          NEW_TAG=$(echo "$LATEST_TAG" | awk -F'-r' '{suffix=$2; if (!suffix) suffix=0; suffix++; printf "%s-r%d", $1, suffix}')
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
          git tag $NEW_TAG
          git push origin $NEW_TAG

      - name: Generate changelog
        if: ${{ github.event.inputs.generate_changelog == 'true' }}
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD)
          else
            CHANGELOG="Initial release."
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: notes
        run: |
          cat << EOF > release_notes.md
          # ${{ env.RELEASE_NAME }}

          **Kernel Version:** ${{ needs.build.outputs.kernel_full_ver }}
          **KSU Version:** ${{ needs.build.outputs.ksu_version }}
          **SUSFS Version:** ${{ needs.build.outputs.susfs_version }}

          ## Features
          - KernelSU Next / SukiSU Ultra
          - SUSFS
          - Memkernel driver
          - BBG (Baseband Guard)
          - Optimized with ${{ github.event.inputs.optimize_level }}

          EOF

          if [ "${{ github.event.inputs.generate_changelog }}" == "true" ]; then
            echo "## Changelog" >> release_notes.md
            echo "${{ steps.changelog.outputs.changelog }}" >> release_notes.md
          fi

          echo "## Artifacts" >> release_notes.md
          for file in downloaded-artifacts/*/*.{zip,txt}; do
            if [ -f "$file" ]; then
              echo "- $(basename "$file")" >> release_notes.md
            fi
          done

      - name: Create GitHub Pre-release
        if: ${{ github.event.inputs.release_type == 'Pre-release' }}
        run: |
          gh release create "${{ env.NEW_TAG }}" \
            --repo "${{ github.repository }}" \
            --title "${{ env.RELEASE_NAME }} (Pre-release)" \
            --notes-file release_notes.md \
            --prerelease

      - name: Create GitHub Release
        if: ${{ github.event.inputs.release_type == 'Release' }}
        run: |
          gh release create "${{ env.NEW_TAG }}" \
            --repo "${{ github.repository }}" \
            --title "${{ env.RELEASE_NAME }}" \
            --notes-file release_notes.md

      - name: Upload assets to release
        run: |
          for file in downloaded-artifacts/*/*.{zip,txt}; do
            if [ -f "$file" ]; then
              echo "Uploading $file"
              gh release upload "${{ env.NEW_TAG }}" "$file" --clobber
            fi
          done
