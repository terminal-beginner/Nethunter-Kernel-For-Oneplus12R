name: Build OnePlus 12r Docker Kernel (with KernelSU Next, SUSFS, BBG)
on:
  workflow_dispatch:
    inputs:
      ksu_commit_hash:
        description: 'KernelSU Next commit hash (leave empty for latest dev)'
        required: false
        type: string
        default: ''
      susfs_branch_or_commit:
        description: 'SUSFS branch or commit hash (empty for auto-detect based on kernel)'
        required: false
        type: string
        default: ''
      kernel_uname:
        description: 'Custom kernel uname (e.g., Bright-Star)'
        required: false
        type: string
        default: 'Bright-Star'
      optimize_level:
        description: 'Compiler optimization level (O2 or O3)'
        required: true
        type: choice
        options: ['O2', 'O3']
        default: 'O2'
      build_modules:
        description: 'Build kernel modules (yes/no)'
        required: true
        type: choice
        options: ['no', 'yes']
        default: 'no'
      release_type:
        description: 'Select type of Github release?'
        required: true
        type: choice
        options:
          - none
          - Pre-release
          - Release
        default: none
      manifest:
        description: 'Select manifest (used for release name)'
        required: true
        type: choice
        options:
          - OOS14
          - OOS15
          - OOS16
        default: OOS16
      model:
        description: 'Device model (for release name)'
        required: true
        type: string
        default: 'OP12r'

jobs:
  build-kernel:
    name: Build Kernel
    runs-on: ubuntu-latest
    outputs:
      kernel_full_ver: ${{ steps.version.outputs.kernel_full_ver }}
      ksu_version: ${{ steps.ksu.outputs.ksu_version }}
      susfs_version: ${{ steps.susfs.outputs.susfs_version }}
      build_time: ${{ env.BUILD_TIME }}
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
    steps:
      - name: Set swap to 10G
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 10

      - name: Setup build kernel environment
        run: |
          echo "BUILD_TIME=$(TZ=Asia/Shanghai date "+%y%m%d")" >> $GITHUB_ENV
          echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          sudo apt-get update
          sudo apt-get install -y git wget dwarves libelf-dev ccache automake flex lzop bison gperf build-essential zip curl zlib1g-dev g++-multilib libxml2-utils bzip2 libbz2-dev libbz2-1.0 libghc-bzlib-dev squashfs-tools pngcrush schedtool dpkg-dev liblz4-tool make optipng maven libssl-dev pwgen libswitch-perl policycoreutils minicom libxml-sax-base-perl libxml-simple-perl bc libc6-dev-i386 libx11-dev lib32z-dev libgl1-mesa-dev xsltproc unzip device-tree-compiler python3 jq
          mkdir -p $GITHUB_WORKSPACE/kernel_workspace

      - name: Validate inputs
        run: |
          if [[ -n "${{ github.event.inputs.ksu_commit_hash }}" ]]; then
            if [[ ! "${{ github.event.inputs.ksu_commit_hash }}" =~ ^[a-f0-9]{40}$ ]]; then
              echo "::error::ksu_commit_hash must be a 40-character hex string"
              exit 1
            fi
          fi
          echo "Input validation passed."

      - name: Cache kernel source
        id: cache-kernel
        uses: actions/cache@v4
        with:
          path: kernel_workspace
          key: kernel-source-${{ inputs.manifest }}-${{ env.CACHE_DATE }}
          restore-keys: |
            kernel-source-${{ inputs.manifest }}-
            kernel-source-

      - name: Download kernel source (if not cached)
        if: steps.cache-kernel.outputs.cache-hit != 'true'
        run: |
          rm -rf kernel_workspace
          git clone https://github.com/OnePlusOSS/android_kernel_modules_and_devicetree_oneplus_sm8550 -b oneplus/sm8550_b_16.0.0_oneplus_12r kernel_workspace --depth=1
          cd kernel_workspace/kernel_platform
          git clone https://github.com/terminal-beginner/android_kernel_common_oneplus_12r.git -b oneplus/sm8550_b_16.0.0_oneplus_12r common --depth=1

      - name: Clean up ABI protected exports
        run: |
          cd kernel_workspace/kernel_platform
          rm -f common/android/abi_gki_protected_exports_* || true
          rm -f msm-kernel/android/abi_gki_protected_exports_* || true

      - name: Get kernel version info
        id: version
        run: |
          cd kernel_workspace/kernel_platform/common
          for f in build.config.common build.config.constants; do
            if [ -f "$f" ]; then
              BRANCH_LINE=$(grep '^[[:space:]]*BRANCH=' "$f" || true)
              [ -n "$BRANCH_LINE" ] && break
            fi
          done
          [ -z "$BRANCH_LINE" ] && { echo "No BRANCH= found"; exit 1; }
          BRANCH_VALUE="${BRANCH_LINE#*=}"
          ANDROID_VERSION="${BRANCH_VALUE%-*}"
          VERSION=$(grep '^VERSION *=' Makefile | awk '{print $3}')
          PATCHLEVEL=$(grep '^PATCHLEVEL *=' Makefile | awk '{print $3}')
          SUBLEVEL=$(grep '^SUBLEVEL *=' Makefile | awk '{print $3}')
          FULL_VERSION="$VERSION.$PATCHLEVEL.$SUBLEVEL"
          echo "ANDROID_VER=$ANDROID_VERSION" >> $GITHUB_ENV
          echo "KERNEL_VER=$VERSION.$PATCHLEVEL" >> $GITHUB_ENV
          echo "KERNEL_FULL_VER=$ANDROID_VERSION-$FULL_VERSION" >> $GITHUB_ENV
          echo "SUSFS_KERNEL_BRANCH=gki-$ANDROID_VERSION-$VERSION.$PATCHLEVEL" >> $GITHUB_ENV
          echo "kernel_full_ver=$ANDROID_VERSION-$FULL_VERSION" >> $GITHUB_OUTPUT

      - name: Add KernelSU Next
        id: ksu
        run: |
          cd kernel_workspace/kernel_platform
          curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/dev/kernel/setup.sh" | bash -
          git submodule update --init --recursive
          if [ -n "${{ github.event.inputs.ksu_commit_hash }}" ]; then
            cd KernelSU-Next
            git checkout "${{ github.event.inputs.ksu_commit_hash }}"
            cd kernel
          else
            cd KernelSU-Next/kernel
          fi
          COMMITS_COUNT=$(git rev-list --count HEAD)
          if [ $COMMITS_COUNT -lt 2684 ]; then
            BASE_VERSION=10200
          else
            BASE_VERSION=30000
          fi
          KSU_VERSION=$((COMMITS_COUNT + BASE_VERSION))
          sed -i "s/DKSU_VERSION=11998/DKSU_VERSION=${KSU_VERSION}/" Makefile
          echo "ksu_version=$KSU_VERSION" >> $GITHUB_OUTPUT
          cd ../..

      - name: Clone SUSFS
        run: |
          cd $GITHUB_WORKSPACE
          git clone https://gitlab.com/simonpunk/susfs4ksu.git
          cd susfs4ksu
          SUSFS_BRANCH="${{ github.event.inputs.susfs_branch_or_commit }}"
          if [ -z "$SUSFS_BRANCH" ]; then
            SUSFS_BRANCH="${{ env.SUSFS_KERNEL_BRANCH }}"
          fi
          if git rev-parse --verify "origin/$SUSFS_BRANCH" >/dev/null 2>&1 || git rev-parse --verify "$SUSFS_BRANCH" >/dev/null 2>&1; then
            git checkout "$SUSFS_BRANCH"
            SUSFS_COMMIT_SHA=$(git rev-parse HEAD)
            echo "SUSFS_COMMIT_SHA=$SUSFS_COMMIT_SHA" >> $GITHUB_ENV
            echo "Checked out SUSFS branch: $SUSFS_BRANCH"
          else
            echo "::error::SUSFS branch '$SUSFS_BRANCH' not found."
            exit 1
          fi

      - name: Clone kernel_patches
        run: |
          cd $GITHUB_WORKSPACE
          git clone --depth=1 https://github.com/TheWildJames/kernel_patches.git

      - name: Clone my_patches
        run: |
          cd $GITHUB_WORKSPACE
          git clone --depth=1 https://github.com/terminal-beginner/kernel_patches.git my_patches

      - name: Apply SUSFS patches (idempotent)
        id: susfs
        run: |
          cd kernel_workspace/kernel_platform
          # Check if already patched
          if [ -f "common/include/linux/susfs.h" ]; then
            echo "SUSFS already applied, skipping patches"
            # Extract version from existing susfs.h
            susfs_version=$(grep '#define SUSFS_VERSION' common/include/linux/susfs.h | awk -F'"' '{print $2}')
            echo "susfs_version=$susfs_version" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Copy SUSFS files
          cp $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/50_add_susfs_in_${{ env.SUSFS_KERNEL_BRANCH }}.patch ./common/
          cp $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/fs/* ./common/fs/
          cp $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/

          cd KernelSU-Next
          susfs_version=$(grep '#define SUSFS_VERSION' ../common/include/linux/susfs.h | awk -F'"' '{print $2}')
          echo "susfs_version=$susfs_version" >> $GITHUB_OUTPUT

          cp $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./
          patch -p1 --forward < 10_enable_susfs_for_ksu.patch || true

          case "$susfs_version" in
            "v1.5.8")
              cp $GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/fix_apk_sign.c.patch ./
              patch -p1 --forward --fuzz=3 < fix_apk_sign.c.patch
              cp $GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/fix_core_hook.c.patch ./
              patch -p1 --forward --fuzz=3 < fix_core_hook.c.patch
              cp $GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/fix_selinux.c.patch ./
              patch -p1 --forward --fuzz=3 < fix_selinux.c.patch
              cp $GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/fix_ksud.c.patch ./
              patch -p1 --forward --fuzz=3 < fix_ksud.c.patch
              ;;
            "v1.5.9"|"v1.5.10"|"v1.5.11"|"v1.5.12")
              for file in $(find ./kernel -maxdepth 2 -name "*.rej" -printf "%f\n" | cut -d'.' -f1); do
                echo "Patching file: $file.c with fix_$file.c.patch"
                patch -p1 --forward < "$GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/fix_$file.c.patch"
              done
              patch -p1 --forward < "$GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/fix_kernel_compat.c.patch"
              ;;
            "v2.0.0")
              for file in $(find ./kernel -maxdepth 2 -name "*.rej" -exec basename {} .rej \;); do
                echo "Patching file: $file with fix_$file.patch"
                patch -p1 --forward < "$GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/fix_$file.patch"
              done
              patch -p1 --forward < "$GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/overwrite_hook_mode.patch"
              patch -p1 --forward < "$GITHUB_WORKSPACE/kernel_patches/next/susfs_fix_patches/$susfs_version/ksu_toolkit.patch"
              ;;
            *)
              echo "Unsupported SUSFS version: $susfs_version"
              exit 1
              ;;
          esac

          cd ../common
          patch -p1 < $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/50_add_susfs_in_${{ env.SUSFS_KERNEL_BRANCH }}.patch

          KERNEL_VERSION="${{ env.KERNEL_VER }}"
          MIN_VERSION="5.16"
          if [ "$(printf '%s\n' "$KERNEL_VERSION" "$MIN_VERSION" | sort -V | head -n1)" = "$KERNEL_VERSION" ]; then
            echo "Applying ptrace patch"
            patch -p1 -F 3 < "$GITHUB_WORKSPACE/kernel_patches/gki_ptrace.patch"
          fi

      - name: Apply my patches
        run: |
          cd kernel_workspace/kernel_platform/common
          for patch_file in $GITHUB_WORKSPACE/my_patches/kernel_patches/op11/common/*.patch; do
            if [ -f "$patch_file" ]; then
              echo "Applying $patch_file"
              patch -p1 < "$patch_file"
            fi
          done

      - name: Add memkernel module
        run: |
          cd kernel_workspace/kernel_platform/common
          curl -LSs "https://raw.githubusercontent.com/Poko-Apps/MemKernel/main/kernel/setup.sh" | bash -s M br0k3n

      - name: Add BBG
        continue-on-error: true
        run: |
          cd kernel_workspace/kernel_platform
          if ! wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash -s fix_blkdev_rename; then
            echo "::warning::BBG setup script failed, continuing anyway"
          fi

      - name: Download Clang-aosp
        run: |
          cd kernel_workspace
          mkdir clang-aosp
          wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master-kernel-build-2022/clang-r450784e.tar.gz
          tar -C clang-aosp/ -zxvf clang-r450784e.tar.gz

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2.19
        with:
          key: ${{ env.KERNEL_FULL_VER }}
          max-size: 5G
          append-timestamp: false
          create-symlink: true
          job-summary: 'CCache stats'
          save: true

      - name: Build kernel
        run: |
          cd kernel_workspace
          KERNEL_DIR=./kernel_platform/common
          OUT_DIR=../../out
          DEFCONFIG="gki_defconfig vendor/kalama_GKI.config"
          export PATH=$PWD/clang-aosp/bin:$PATH
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export ARCH=arm64 SUBARCH=arm64 HEADER_ARCH=arm64
          export PATH="/usr/lib/ccache:$PATH"

          TOOL_ARGS=("ARCH=${ARCH}" "SUBARCH=${SUBARCH}" "HEADER_ARCH=${HEADER_ARCH}")
          CC=clang CXX=clang++ && TOOL_ARGS+=("CC=${CC}" "CXX=${CXX}")
          LD=ld.lld AR=llvm-ar NM=llvm-nm OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump READELF=llvm-readelf OBJSIZE=llvm-size STRIP=llvm-strip && TOOL_ARGS+=("LD=${LD}" "AR=${AR}" "NM=${NM}" "OBJCOPY=${OBJCOPY}" "OBJDUMP=${OBJDUMP}" "STRIP=${STRIP}")
          LLVM=1 LLVM_IAS=1 && TOOL_ARGS+=("LLVM=${LLVM}" "LLVM_IAS=${LLVM_IAS}")

          cd ${KERNEL_DIR}
          THREAD=$(nproc --all)

          make -j"$THREAD" "${TOOL_ARGS[@]}" O=${OUT_DIR} ${DEFCONFIG}
          scripts/config --file ${OUT_DIR}/.config -e LTO_CLANG -d LTO_NONE -e LTO_CLANG_THIN -d LTO_CLANG_FULL -e THINLTO
          wget https://raw.githubusercontent.com/terminal-beginner/Kernel-Builder_Action/refs/heads/Original/patches/a16_defconfig
          mv a16_defconfig ${OUT_DIR}/.config

          if [ "${{ github.event.inputs.optimize_level }}" = "O3" ]; then
            scripts/config --file ${OUT_DIR}/.config -d CC_OPTIMIZE_FOR_PERFORMANCE
            scripts/config --file ${OUT_DIR}/.config -e CC_OPTIMIZE_FOR_PERFORMANCE_O3
            KCFLAGS_EXTRA="-O3"
          else
            scripts/config --file ${OUT_DIR}/.config -e CC_OPTIMIZE_FOR_PERFORMANCE
            scripts/config --file ${OUT_DIR}/.config -d CC_OPTIMIZE_FOR_PERFORMANCE_O3
            KCFLAGS_EXTRA="-O2"
          fi

          scripts/config --file ${OUT_DIR}/.config --set-str LOCALVERSION "-${ANDROID_VER}-${{ github.event.inputs.kernel_uname }}"
          scripts/config --file ${OUT_DIR}/.config -d LOCALVERSION_AUTO

          make -j"$THREAD" O=${OUT_DIR} "${TOOL_ARGS[@]}" KCFLAGS="-Wno-error -pipe -fno-stack-protector ${KCFLAGS_EXTRA}" KCPPFLAGS="-DCONFIG_OPTIMIZE_INLINING" Image

      - name: Save kernel artifacts (config + symvers)
        run: |
          mkdir -p artifacts
          cp kernel_workspace/out/.config artifacts/kernel_config_${{ env.KERNEL_FULL_VER }}.txt
          cp kernel_workspace/out/Module.symvers artifacts/Module.symvers_${{ env.KERNEL_FULL_VER }}.txt
          echo "${{ env.KERNEL_FULL_VER }}" > artifacts/OnePlus12r.txt

      - name: Make Anykernel3
        run: |
          cd kernel_workspace
          git clone https://github.com/Kernel-SU/AnyKernel3 --depth=1 AnyKernel3
          cp out/arch/arm64/boot/Image AnyKernel3/
          cd AnyKernel3
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
          sed -i 's!block=/dev/block/platform/omap/omap_hsmmc.0/by-name/boot;!block=/dev/block/bootdevice/by-name/boot;!g' anykernel.sh
          sed -i 's/is_slot_device=0;/is_slot_device=1;/g' anykernel.sh
          zip -r9 update.zip * -x .git README.md *placeholder
          mkdir -p ../artifacts
          cp update.zip ../artifacts/AnyKernel3_OnePlus12r_${{ env.KERNEL_FULL_VER }}_Next_${{ steps.ksu.outputs.ksu_version }}_SuSFS_${{ steps.susfs.outputs.susfs_version }}.zip

      - name: Debug ccache stats
        run: |
          echo "CCache Statistics:"
          ccache -s
          echo "Cache key used: ${{ env.KERNEL_FULL_VER }}"
          echo "Cache hit rate: $(ccache -s | grep 'cache hit rate' | awk '{print $4}')"

      - name: Final Build Summary
        run: |
          {
            echo "### Kernel Build Summary"
            echo ""
            echo "- **Model:** OnePlus ${{ inputs.model }}"
            echo "- **Android:** ${{ env.ANDROID_VER }}"
            echo "- **Kernel Version:** ${{ env.KERNEL_FULL_VER }}"
            echo "- **Kernel Uname:** ${{ inputs.kernel_uname }}"
            echo "- **KSUN Version:** ${{ steps.ksu.outputs.ksu_version }}"
            echo "- **SUSFS Version:** ${{ steps.susfs.outputs.susfs_version }}"
            echo "- **Optimization:** ${{ inputs.optimize_level }}"
            echo "- **Build Time:** ${{ env.BUILD_TIME }}"
            echo ""
            echo "#### CCache Statistics"
            echo '```'
            ccache -s
            echo '```'
          } >> $GITHUB_STEP_SUMMARY

      - name: Upload kernel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ env.KERNEL_FULL_VER }}
          path: artifacts/
          retention-days: 7
          if-no-files-found: error

  build-modules:
    name: Build Kernel Modules
    needs: build-kernel
    if: github.event.inputs.build_modules == 'yes'
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CACHE_DATE: ${{ needs.build-kernel.outputs.build_time }}
    steps:
      - name: Setup build kernel environment
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget dwarves libelf-dev ccache automake flex lzop bison gperf build-essential zip curl zlib1g-dev g++-multilib libxml2-utils bzip2 libbz2-dev libbz2-1.0 libghc-bzlib-dev squashfs-tools pngcrush schedtool dpkg-dev liblz4-tool make optipng maven libssl-dev pwgen libswitch-perl policycoreutils minicom libxml-sax-base-perl libxml-simple-perl bc libc6-dev-i386 libx11-dev lib32z-dev libgl1-mesa-dev xsltproc unzip device-tree-compiler python3 jq

      - name: Cache kernel source
        id: cache-kernel
        uses: actions/cache@v4
        with:
          path: kernel_workspace
          key: kernel-source-${{ inputs.manifest }}-${{ env.CACHE_DATE }}
          restore-keys: |
            kernel-source-${{ inputs.manifest }}-
            kernel-source-

      - name: Download kernel source (if not cached)
        if: steps.cache-kernel.outputs.cache-hit != 'true'
        run: |
          rm -rf kernel_workspace
          git clone https://github.com/OnePlusOSS/android_kernel_modules_and_devicetree_oneplus_sm8550 -b oneplus/sm8550_b_16.0.0_oneplus_12r kernel_workspace --depth=1
          cd kernel_workspace/kernel_platform
          git clone https://github.com/terminal-beginner/android_kernel_common_oneplus_12r.git -b oneplus/sm8550_b_16.0.0_oneplus_12r common --depth=1

      - name: Download kernel config and symvers
        uses: actions/download-artifact@v4
        with:
          name: kernel-${{ needs.build-kernel.outputs.kernel_full_ver }}
          path: downloaded-artifacts

      - name: Prepare kernel build tree
        run: |
          cd kernel_workspace/kernel_platform/common
          cp $GITHUB_WORKSPACE/downloaded-artifacts/kernel_config_${{ needs.build-kernel.outputs.kernel_full_ver }}.txt .config
          cp $GITHUB_WORKSPACE/downloaded-artifacts/Module.symvers_${{ needs.build-kernel.outputs.kernel_full_ver }}.txt Module.symvers
          mkdir -p out
          make O=out olddefconfig
          make O=out modules_prepare

      - name: Download Clang-aosp
        run: |
          cd kernel_workspace
          mkdir clang-aosp
          wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master-kernel-build-2022/clang-r450784e.tar.gz
          tar -C clang-aosp/ -zxvf clang-r450784e.tar.gz

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2.19
        with:
          key: modules-${{ needs.build-kernel.outputs.kernel_full_ver }}
          max-size: 2G
          save: true

      - name: Build modules
        run: |
          cd kernel_workspace
          KERNEL_DIR=./kernel_platform/common
          OUT_DIR=../../out
          export PATH=$PWD/clang-aosp/bin:$PATH
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export ARCH=arm64 SUBARCH=arm64 HEADER_ARCH=arm64
          export PATH="/usr/lib/ccache:$PATH"

          TOOL_ARGS=("ARCH=${ARCH}" "SUBARCH=${SUBARCH}" "HEADER_ARCH=${HEADER_ARCH}")
          CC=clang CXX=clang++ && TOOL_ARGS+=("CC=${CC}" "CXX=${CXX}")
          LD=ld.lld AR=llvm-ar NM=llvm-nm OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump READELF=llvm-readelf OBJSIZE=llvm-size STRIP=llvm-strip && TOOL_ARGS+=("LD=${LD}" "AR=${AR}" "NM=${NM}" "OBJCOPY=${OBJCOPY}" "OBJDUMP=${OBJDUMP}" "STRIP=${STRIP}")
          LLVM=1 LLVM_IAS=1 && TOOL_ARGS+=("LLVM=${LLVM}" "LLVM_IAS=${LLVM_IAS}")

          cd ${KERNEL_DIR}
          THREAD=$(nproc --all)

          make -j"$THREAD" O=${OUT_DIR} "${TOOL_ARGS[@]}" modules

      - name: Collect and filter kernel modules
        run: |
          cd kernel_workspace/out
          MODULES_COLLECTION="modules_collection"
          mkdir -p "$MODULES_COLLECTION"
          find . -name "*.ko" -type f -exec cp {} "$MODULES_COLLECTION" \;
          if [ -n "$(ls -A "$MODULES_COLLECTION")" ]; then
            cd "$MODULES_COLLECTION"
            curl -L -o default_modules.txt https://raw.githubusercontent.com/nullptr-t-oss/kernel_patches/refs/heads/main/default_modules.txt
            while IFS= read -r module; do
              if [ -e "$module" ]; then
                rm -f "$module"
                echo "Removed module: $module"
              fi
            done < default_modules.txt
            MODULES_ZIP="kernel_modules_OnePlus12r_${{ needs.build-kernel.outputs.kernel_full_ver }}.zip"
            zip -r "$MODULES_ZIP" ./*
            mkdir -p $GITHUB_WORKSPACE/artifacts
            mv "$MODULES_ZIP" $GITHUB_WORKSPACE/artifacts/
            echo "Kernel modules zip created: $MODULES_ZIP"
          else
            echo "No kernel modules found."
          fi

      - name: Debug ccache stats
        run: |
          echo "CCache Statistics (modules):"
          ccache -s
          echo "Cache key used: modules-${{ needs.build-kernel.outputs.kernel_full_ver }}"
          echo "Cache hit rate: $(ccache -s | grep 'cache hit rate' | awk '{print $4}')"

      - name: Upload modules artifacts
        uses: actions/upload-artifact@v4
        with:
          name: modules-${{ needs.build-kernel.outputs.kernel_full_ver }}
          path: artifacts/
          retention-days: 7
          if-no-files-found: error

  trigger-release:
    needs: [build-kernel, build-modules]
    runs-on: ubuntu-latest
    if: ${{ inputs.release_type != 'none' }}
    env:
      REPO_OWNER: ${{ github.repository_owner }}
      REPO_NAME: ${{ github.event.repository.name }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      OS_VERSION: ${{ inputs.manifest }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Wireless Firmware Module
        env:
          SOURCE_REPO: nullptr-t-oss/Nethunter-Wireless-Firmware
        run: |
          DOWNLOAD_DIR="./downloaded-artifacts/wireless-firmware"
          mkdir -p "$DOWNLOAD_DIR"
          LATEST_RELEASE_TAG=$(gh api repos/$SOURCE_REPO/releases/latest --jq '.tag_name' 2>/dev/null || echo "")
          if [ -z "$LATEST_RELEASE_TAG" ]; then
            echo "::warning::Could not find a latest release in $SOURCE_REPO. Skipping external download."
            exit 0
          fi
          EXPECTED_ASSET_NAME="$(basename $SOURCE_REPO)-${LATEST_RELEASE_TAG}.zip"
          gh release download $LATEST_RELEASE_TAG --repo $SOURCE_REPO --pattern $EXPECTED_ASSET_NAME --dir $DOWNLOAD_DIR --clobber

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./downloaded-artifacts

      - name: Generate Release name
        run: |
          DEVICE="OnePlus ${{ inputs.model }}"
          RELEASE_NAME="$DEVICE EmberHeart Kernel With KernelSU Next, Nethunter & SUSFS v2.0.0"
          echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV

      - name: Generate and Create New Tag
        run: |
          BASE_TAG="v2.0.0-r0"
          LATEST_TAG=$(gh api repos/$REPO_OWNER/$REPO_NAME/tags --jq '.[0].name' 2>/dev/null || echo "")
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="$BASE_TAG"
          else
            LATEST_TAG=$(printf "%s\n%s\n" "$LATEST_TAG" "$BASE_TAG" | sort -rV | head -n1)
          fi
          NEW_TAG=$(echo "$LATEST_TAG" | awk -F'-r' '{suffix=$2; if (!suffix) suffix=0; suffix++; printf "%s-r%d", $1, suffix}')
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
          git tag $NEW_TAG
          git push origin $NEW_TAG

      - name: Generate Changelog
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD)
          else
            CHANGELOG="Initial release."
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate Device List and Final Release Notes
        id: generate-notes
        run: |
          cat << EOF > release_notes.md
          This release contains KernelSU Next and SUSFS v2.0.0

          Module:
          -> https://github.com/sidex15/ksu_module_susfs

          Official Managers:
          -> https://github.com/KernelSU-Next/KernelSU-Next

          Non-Official Managers:
          -> https://github.com/WildKernels/Wild_KSU

          ### Built Devices

          | Model | Kernel Version |
          |-------|----------------|
          EOF

          find downloaded-artifacts -name "*.txt" -type f | sort | while read -r file; do
            model=$(basename "$file" .txt)
            version=$(cat "$file")
            printf "| %-12s | %-16s |\n" "$model" "$version" >> release_notes.md
          done

          cat << 'EOF' >> release_notes.md

          ### Features
          - [+] KernelSU-Next / WildKSU Manager Support
          - [+] SUSFS v2.0.0
          - [+] Wireguard Support
          - [+] Magic Mount Support
          - [+] Ptrace message leak fix for kernels < 5.16
          - [+] Manual Hooks [scope_min_manual_hooks_v1.4]
          - [+] CONFIG_TMPFS_XATTR Support [Mountify Support]
          - [+] BBR v1 Support
          - [+] Baseband Guard Support (BBG)
          - [+] Nethunter Support
          - [+] Mem kernel driver by @Poko-Apps [r/w to physical memory]
          - [+] IP Set Support

          ### Changelog
          ${{ steps.changelog.outputs.changelog }}

          ### Asset Checksums
          EOF

          for file in downloaded-artifacts/*/*.{zip,img}; do
            if [ -f "$file" ]; then
              sha=$(sha256sum "$file" | cut -d' ' -f1)
              echo "- \`$(basename "$file")\`: \`$sha\`" >> release_notes.md
            fi
          done

      - name: Create GitHub Pre-release
        if: ${{ inputs.release_type == 'Pre-release' }}
        run: |
          gh release create "${{ env.NEW_TAG }}" \
            --repo "${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}" \
            --title "*Test-build*-${{ env.RELEASE_NAME }}-${{ env.OS_VERSION }}*Test Build*" \
            --notes-file release_notes.md \
            --prerelease

      - name: Create GitHub Release
        if: ${{ inputs.release_type == 'Release' }}
        run: |
          gh release create "${{ env.NEW_TAG }}" \
            --repo "${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}" \
            --title "${{ env.RELEASE_NAME }}-${{ env.OS_VERSION }}" \
            --notes-file release_notes.md

      - name: Upload Release Assets Dynamically
        run: |
          for file in ./downloaded-artifacts/*/*.{zip,img}; do
            if [ -f "$file" ]; then
              echo "Uploading $file..."
              gh release upload "${{ env.NEW_TAG }}" "$file" --clobber
            fi
          done
